{"componentChunkName":"component---src-templates-blog-post-js","path":"/2020-07-29-the-diff-between-promise-all-and-promise-allsettled/","result":{"data":{"site":{"siteMetadata":{"title":"上线前夕"}},"markdownRemark":{"id":"049626cb-defa-539e-9b8a-f2f534d2d0b5","excerpt":"不管你是否还学的动，JS语言依然在以自己的节奏飞快的进化。转眼间，Promise的工具包里又多了一个方法Promise.allSettled供你选择，它看起来像是对Promise.all的一种补充，缓解了使用Promise.all碰到reject的痛点问题。 一句话概括Promise.allSettled…","html":"<p>不管你是否还学的动，JS语言依然在以自己的节奏飞快的进化。转眼间，Promise的工具包里又多了一个方法Promise.allSettled供你选择，它看起来像是对Promise.all的一种补充，缓解了使用Promise.all碰到reject的痛点问题。</p>\n<p>一句话概括Promise.allSettled和Promise.all的最大不同：<strong>Promise.allSettled永远不会被reject</strong>。</p>\n<h3>解决Promise.all的痛点</h3>\n<p>当需要处理多个Promise并行时，大多数情况下Promise.all用起来是非常顺手的，比如下面这样</p>\n\n        <deckgo-highlight-code language=\"javascript\" >\n          <code slot=\"code\">const delay = n =&gt; new Promise(resolve =&gt; setTimeout(resolve, n));\n\nconst promises = [\n  delay(100).then(() =&gt; 1),\n  delay(200).then(() =&gt; 2),\n  ]\n\nPromise.all(promises).then(values=&gt;console.log(values))\n// 最终输出： [1, 2]</code>\n        </deckgo-highlight-code>\n      \n<p>可是，是一旦有一个promise出现了异常，被reject了，情况就会变的麻烦。</p>\n\n        <deckgo-highlight-code language=\"javascript\" >\n          <code slot=\"code\">const promises = [\n  delay(100).then(() =&gt; 1),\n  delay(200).then(() =&gt; 2),\n  Promise.reject(3)\n  ]\n\nPromise.all(promises).then(values=&gt;console.log(values))\n// 最终输出： Uncaught (in promise) 3\n\nPromise.all(promises)\n.then(values=&gt;console.log(values))\n.catch(err=&gt;console.log(err))\n// 加入catch语句后，最终输出：3</code>\n        </deckgo-highlight-code>\n      \n<p>尽管能用catch捕获其中的异常，但你会发现其他执行成功的Promise的消息都丢失了，仿佛石沉大海一般。</p>\n<p>要么全部成功，要么全部重来，这是Promise.all本身的强硬逻辑，也是痛点的来源，不能说它错，但这的确给Promise.allSettled留下了立足的空间。</p>\n<p>假如使用Promise.allSettled来处理这段逻辑会怎样呢?</p>\n\n        <deckgo-highlight-code language=\"javascript\" >\n          <code slot=\"code\">const promises = [\n  delay(100).then(() =&gt; 1),\n  delay(200).then(() =&gt; 2),\n  Promise.reject(3)\n  ]\n\nPromise.allSettled(promises).then(values=&gt;console.log(values))\n// 最终输出： \n//    [\n//      {status: &quot;fulfilled&quot;, value: 1},\n//      {status: &quot;fulfilled&quot;, value: 2},\n//      {status: &quot;rejected&quot;, value: 3},\n//    ]</code>\n        </deckgo-highlight-code>\n      \n<p>可以看到所有promise的数据都被包含在then语句中，且每个promise的返回值多了一个status字段，表示当前promise的状态，没有任何一个promise的信息被丢失。</p>\n<p>因此，当用Promise.allSettled时，我们只需专注在then语句里，当有promise被异常打断时，我们依然能妥善处理那些已经成功了的promise，不必全部重来。</p>\n<h3>当前大环境对Promise.allSettled的支持</h3>\n<p>nodejs从<a href=\"https://nodejs.org/en/blog/release/v12.9.0/\">v12.9.0</a>开始加入了对Promise.allSettled的支持，主流浏览器们也各自在2019年发布的版本中支持了此方法，这意味着你已经可以放心大胆的使用了。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3bf09ec83b7e9f15e982ddae3ed993f4/67ee3/cover.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 25%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wgARCAAFABQDASIAAhEBAxEB/8QAFwABAAMAAAAAAAAAAAAAAAAAAAEDBv/EABYBAQEBAAAAAAAAAAAAAAAAAAIBA//aAAwDAQACEAMQAAAB0dxhZCX/xAAaEAABBQEAAAAAAAAAAAAAAAABAAMREhMi/9oACAEBAAEFAiHLDSO1/8QAFhEBAQEAAAAAAAAAAAAAAAAAARAh/9oACAEDAQE/AR2f/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAGhAAAgIDAAAAAAAAAAAAAAAAAAEykRETkv/aAAgBAQAGPwLGxck1RJUf/8QAGhAAAgIDAAAAAAAAAAAAAAAAASEA8DFBcf/aAAgBAQABPyHTAyoSRXmBXb2f/9oADAMBAAIAAwAAABAL7//EABURAQEAAAAAAAAAAAAAAAAAAAEA/9oACAEDAQE/EGXN/8QAFhEAAwAAAAAAAAAAAAAAAAAAARAx/9oACAECAQE/EBV//8QAGRABAAMBAQAAAAAAAAAAAAAAAQARIVGh/9oACAEBAAE/EC1ml4M9mKJGZb7AAEPREf/Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"cover\"\n        title=\"cover\"\n        src=\"/static/3bf09ec83b7e9f15e982ddae3ed993f4/625aa/cover.jpg\"\n        srcset=\"/static/3bf09ec83b7e9f15e982ddae3ed993f4/c4d45/cover.jpg 148w,\n/static/3bf09ec83b7e9f15e982ddae3ed993f4/1f0d7/cover.jpg 295w,\n/static/3bf09ec83b7e9f15e982ddae3ed993f4/625aa/cover.jpg 590w,\n/static/3bf09ec83b7e9f15e982ddae3ed993f4/f8367/cover.jpg 885w,\n/static/3bf09ec83b7e9f15e982ddae3ed993f4/fab84/cover.jpg 1180w,\n/static/3bf09ec83b7e9f15e982ddae3ed993f4/67ee3/cover.jpg 2548w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>对于那些不支持此方法的环境，你可以直接引用开源社区中实现了此方法的npm包：</p>\n<ul>\n<li><a href=\"https://www.npmjs.com/package/promise.allsettled\">promise.allsettled</a></li>\n<li><a href=\"https://www.npmjs.com/package/promise-settle\">promise-settle</a></li>\n<li><a href=\"https://www.npmjs.com/package/promise-all-settled\">promise-all-settled</a></li>\n<li><a href=\"https://www.npmjs.com/package/es2015-promise.allsettled\">es2015-promise.allsettled</a></li>\n</ul>\n<p>或者，你可以直接基于Promise.all写一个polyfill，给你的项目打上补丁：</p>\n\n        <deckgo-highlight-code language=\"javascript\" >\n          <code slot=\"code\">if (Promise &amp;&amp; !Promise.allSettled) {\n  Promise.allSettled = function (promises) {\n    return Promise.all(promises.map(function (promise) {\n      return promise.then(function (value) {\n        return { state: &#39;fulfilled&#39;, value: value };\n      }).catch(function (reason) {\n        return { state: &#39;rejected&#39;, reason: reason };\n      });\n    }));\n  };\n}</code>\n        </deckgo-highlight-code>\n      \n<h3>结语</h3>\n<p>Promise.allSettled是对Promise.all的一种补充，当面对多个promise并行时，它额外提供了一种处理方式，解决了当多个promise并行时reject的出现会伴随着其他promise数据丢失的问题。</p>\n<blockquote>\n<h4>参考资料</h4>\n</blockquote>\n<blockquote>\n<p><a href=\"https://medium.com/trabe/using-promise-allsettled-now-e1767d43e480\">using-promise-allsettled-now</a></p>\n</blockquote>\n<blockquote>\n<p><a href=\"https://github.com/tc39/proposal-promise-allSettled\">proposal-promise-allSettled</a></p>\n</blockquote>\n<blockquote>\n<p><a href=\"https://github.com/robhicks/es2015-Promise.allSettled\">es2015-Promise.allSettled</a></p>\n</blockquote>\n<blockquote>\n<p><a href=\"https://nodejs.org/en/blog/release/v12.9.0/\">nodejs v12.9.0 release notes</a></p>\n</blockquote>","frontmatter":{"title":"Promise.all和Promise.allSettled的区别","date":"July 29, 2020","description":null,"cover":{"publicURL":"/static/cover-3bf09ec83b7e9f15e982ddae3ed993f4.jpeg"}}}},"pageContext":{"slug":"/2020-07-29-the-diff-between-promise-all-and-promise-allsettled/","previous":{"fields":{"slug":"/2020-07-24-how-to-build-captive-portal-with-nodogslash/"},"frontmatter":{"title":"如何搭建类似麦当劳店中需登录认证的wifi"}},"next":null}},"staticQueryHashes":["2841359383"]}