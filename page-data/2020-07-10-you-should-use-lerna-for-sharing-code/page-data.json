{"componentChunkName":"component---src-templates-blog-post-js","path":"/2020-07-10-you-should-use-lerna-for-sharing-code/","result":{"data":{"site":{"siteMetadata":{"title":"上线前夕"}},"markdownRemark":{"id":"3de70e93-73a4-512d-a1dc-7b3674ae1fc0","excerpt":"我前段时间参与了一个react为主的大前端项目，覆盖Web、Android、Ios三个平台。由于整个业务逻辑侧重在手机端，且Web端也是到了项目中期才开始启动，我分别以react-native和react分开建了两个项目。 可是，后端微服务集群是同一个，两个项目调用的API…","html":"<p>我前段时间参与了一个<code>react</code>为主的大前端项目，覆盖Web、Android、Ios三个平台。由于整个业务逻辑侧重在手机端，且Web端也是到了项目中期才开始启动，我分别以<code>react-native</code>和<code>react</code>分开建了两个项目。</p>\n<p>可是，后端微服务集群是同一个，两个项目调用的API大多一样，导致两个项目中不可避免的出现了一些重复逻辑。比如说写在redux中的业务逻辑代码，写在http拦截器中的请求处理代码等等，这些重复的部分从目录名和文件名即可肉眼看出。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a9f94d7c2a05226ee95097d466845f6c/500f0/lerna-1.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 66.21621621621621%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wgARCAANABQDASIAAhEBAxEB/8QAGQAAAgMBAAAAAAAAAAAAAAAAAAQBAgMF/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB26tXyBgP/8QAGBABAAMBAAAAAAAAAAAAAAAABAEDBQL/2gAIAQEAAQUCRpKrdqrtNzmIsSO3H4tU4MNgZYGf/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAHRAAAgIDAAMAAAAAAAAAAAAAAREAAgMSEyExUf/aAAgBAQAGPwI0rYadNfUx8im2xBkyF2Zhz9rAm2yUoDc11+Cchbby3P/EABsQAQEBAQADAQAAAAAAAAAAAAERADEhQVHx/9oACAEBAAE/IQmzEnlNHtsKvJgRQqEyg4Cft3l5r2W/mINIqE7v/9oADAMBAAIAAwAAABB4z//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8QP//EABURAQEAAAAAAAAAAAAAAAAAABAh/9oACAECAQE/EIf/xAAaEAEBAQEBAQEAAAAAAAAAAAABEQAxIVGB/9oACAEBAAE/EKBBhuJLbY9ziC4KhEvOuYtWjMGHhvESDQGIv5ja7YhwfciDjNerIb//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"lerna 1\"\n        title=\"lerna 1\"\n        src=\"/static/a9f94d7c2a05226ee95097d466845f6c/625aa/lerna-1.jpg\"\n        srcset=\"/static/a9f94d7c2a05226ee95097d466845f6c/c4d45/lerna-1.jpg 148w,\n/static/a9f94d7c2a05226ee95097d466845f6c/1f0d7/lerna-1.jpg 295w,\n/static/a9f94d7c2a05226ee95097d466845f6c/625aa/lerna-1.jpg 590w,\n/static/a9f94d7c2a05226ee95097d466845f6c/f8367/lerna-1.jpg 885w,\n/static/a9f94d7c2a05226ee95097d466845f6c/fab84/lerna-1.jpg 1180w,\n/static/a9f94d7c2a05226ee95097d466845f6c/500f0/lerna-1.jpg 1584w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b28ebcf115bd83a12640ff733b813eb7/3ed5c/lerna-2.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.810810810810814%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wgARCAAMABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAABAAFBv/EABQBAQAAAAAAAAAAAAAAAAAAAAH/2gAMAwEAAhADEAAAAT9EXfQs+H//xAAXEAEBAQEAAAAAAAAAAAAAAAAEAwUC/9oACAEBAAEFAtJSJu0k1gXLvRAmAlZFyTTIxuCy/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAHxAAAgICAQUAAAAAAAAAAAAAAQIAAxESIRMxQVGR/9oACAEBAAY/ArQl7qoPYGVGp8MTz8m9rbNsZYzFsk+IiWbYX0Z06865zzP/xAAbEAADAQEAAwAAAAAAAAAAAAABESEAMUFRYf/aAAgBAQABPyFcaQgEGnWokC+sKSA0pgBbRYeh8xcOgSPFvJ+UZu//2gAMAwEAAgADAAAAEMQP/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPxA//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPxA//8QAHBABAAMAAgMAAAAAAAAAAAAAAQARIVFxQWGB/9oACAEBAAE/EBiQVmth9jRRLk7A9y5e5/BwoCAZhUQastcQMChdbkPTAmB5HK3Z/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"lerna 2\"\n        title=\"lerna 2\"\n        src=\"/static/b28ebcf115bd83a12640ff733b813eb7/625aa/lerna-2.jpg\"\n        srcset=\"/static/b28ebcf115bd83a12640ff733b813eb7/c4d45/lerna-2.jpg 148w,\n/static/b28ebcf115bd83a12640ff733b813eb7/1f0d7/lerna-2.jpg 295w,\n/static/b28ebcf115bd83a12640ff733b813eb7/625aa/lerna-2.jpg 590w,\n/static/b28ebcf115bd83a12640ff733b813eb7/f8367/lerna-2.jpg 885w,\n/static/b28ebcf115bd83a12640ff733b813eb7/fab84/lerna-2.jpg 1180w,\n/static/b28ebcf115bd83a12640ff733b813eb7/3ed5c/lerna-2.jpg 1864w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>我尝试了将重复部分封装成独立的<code>npm</code>包供两个项目引用，但这个做法仅适用于变化频率较小的工具类代码，一旦封装了变化频繁的业务逻辑代码，用起来也麻烦不断。首先，抽出到项目之外但不易开发和调试，其次，在项目开发过程中业务代码更新太频繁，常常要不断升级版本。权衡利弊，最终得不偿失。</p>\n<p>那么，有没有办法更好的重用这部分代码逻辑呢？有没有办法把这两个项目的通用代码抽取成独立项目，但是又能避开封装成独立<code>npm</code>包的弊端呢？</p>\n<p>我最近尝试引入<a href=\"https://github.com/lerna/lerna\">lerna框架</a>，把这个大前端项目架构作为参照物来改造，惊喜的发现它不但能解决当时项目的痛点，还能额外带来一些多项目管理相关的好处。</p>\n<p>事实上，开源社区早已有很多项目使用了这种多项目合而为一的方案，且采用了lerna框架的代码库也大多耳熟能详，比如国外的有<a href=\"https://github.com/babel/babel\">babel</a>、<a href=\"https://github.com/facebook/create-react-app\">create-react-app</a>、<a href=\"https://github.com/ReactTraining/react-router\">react-router</a>、<a href=\"https://github.com/facebook/jest\">jest</a>、以及国内跨端小程序框架<a href=\"https://github.com/NervJS/taro\">Taro</a>。</p>\n<p>最后经过改造，两个项目合并成一个，重复的代码逻辑也被抽取成另一个独立项目，整个项目结构变成了下面图示这样。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a00b9f7759849d407b42c09f9035d496/b807f/lerna-3.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 67.56756756756756%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wgARCAAOABQDASIAAhEBAxEB/8QAGQAAAgMBAAAAAAAAAAAAAAAAAAIBAwQG/8QAFgEBAQEAAAAAAAAAAAAAAAAAAwEC/9oADAMBAAIQAxAAAAHrLI002HMp/8QAGhABAQEBAAMAAAAAAAAAAAAAAgMBEgQTFP/aAAgBAQABBQKft+i9EdnvQHj6bORek8n/xAAXEQEAAwAAAAAAAAAAAAAAAAACARAR/9oACAEDAQE/ATCyv//EABcRAAMBAAAAAAAAAAAAAAAAAAMQITL/2gAIAQIBAT8BJcr/xAAaEAACAgMAAAAAAAAAAAAAAAAAARESEyJx/9oACAEBAAY/AnZ69FDE2ZLEsg//xAAbEAEAAgMBAQAAAAAAAAAAAAABACERMUFRgf/aAAgBAQABPyHaDesPlQGxVyLtDHaCK1j2AuEAjon/2gAMAwEAAgADAAAAEOsv/8QAGBEBAAMBAAAAAAAAAAAAAAAAAQARIUH/2gAIAQMBAT8QAzRvrcJ//8QAGREAAwEBAQAAAAAAAAAAAAAAAREhADFB/9oACAECAQE/EJUGh4sOXf/EABoQAQEBAQADAAAAAAAAAAAAAAERAEFxgcH/2gAIAQEAAT8QJaomqHkuXsGmL8c11KuViDLH2vNUmiGsLwu//9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"lerna 3\"\n        title=\"lerna 3\"\n        src=\"/static/a00b9f7759849d407b42c09f9035d496/625aa/lerna-3.jpg\"\n        srcset=\"/static/a00b9f7759849d407b42c09f9035d496/c4d45/lerna-3.jpg 148w,\n/static/a00b9f7759849d407b42c09f9035d496/1f0d7/lerna-3.jpg 295w,\n/static/a00b9f7759849d407b42c09f9035d496/625aa/lerna-3.jpg 590w,\n/static/a00b9f7759849d407b42c09f9035d496/f8367/lerna-3.jpg 885w,\n/static/a00b9f7759849d407b42c09f9035d496/fab84/lerna-3.jpg 1180w,\n/static/a00b9f7759849d407b42c09f9035d496/b807f/lerna-3.jpg 1666w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h3>引入lerna</h3>\n<p><code>lerna</code>的名字来源于希腊神话中的九头蛇海德拉（Lernaean Hydra），拿它形容多项目工程是再贴切不过了。</p>\n<p><code>lerna</code>的引入比想象中简单，其实，与其说引入<code>lerna</code>，倒不如说是导入到<code>lerna</code>更合适，因为具体的做法是通过命令行创建了一个新的<code>lerna</code>项目，然后把所有项目导入进去。而且在导入的同时，每个项目的git提交记录也都合并在了一起。</p>\n\n        <deckgo-highlight-code  >\n          <code slot=\"code\">lerna init\nlerna import 你本地的项目路径</code>\n        </deckgo-highlight-code>\n      \n<p>每个被导入的项目都会被存放在根路径的packages目录下，下面是我demo项目的截图，一共引入了三个子项目：rntest, web-app, shared。分别代表mobile，web和可重用的逻辑代码。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/0fd05fdb5e3aa37b6e88431c17443eec/e52ee/lerna-4.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 116.89189189189189%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wgARCAAXABQDASIAAhEBAxEB/8QAGQABAQADAQAAAAAAAAAAAAAAAAMBAgQG/8QAFwEAAwEAAAAAAAAAAAAAAAAAAAECA//aAAwDAQACEAMQAAAB83z9EGbplVolZ4A//8QAGxAAAgMAAwAAAAAAAAAAAAAAAAECERIQIjL/2gAIAQEAAQUC11siyN5bNMj5b4//xAAXEQADAQAAAAAAAAAAAAAAAAAAARAS/9oACAEDAQE/ATSv/8QAFxEAAwEAAAAAAAAAAAAAAAAAAAEQEf/aAAgBAgEBPwEx3//EABcQAQADAAAAAAAAAAAAAAAAABAgITH/2gAIAQEABj8ChrR//8QAHRAAAgMAAgMAAAAAAAAAAAAAAAERITFRYYGR8P/aAAgBAQABPyFMl2pWk5qhjWv2O93uEGN5OwfgIbpCJ+g//9oADAMBAAIAAwAAABC36MD/xAAXEQEBAQEAAAAAAAAAAAAAAAABABAh/9oACAEDAQE/EFIE6Rn/xAAYEQACAwAAAAAAAAAAAAAAAAAAARARMf/aAAgBAgEBPxBDs2f/xAAcEAEAAgIDAQAAAAAAAAAAAAABABEhMUFhcVH/2gAIAQEAAT8QojoFmn3uBWAulidqzwop0DT1uWkajTQgOnDE0cN49llH4QHNEf/Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"lerna 4\"\n        title=\"lerna 4\"\n        src=\"/static/0fd05fdb5e3aa37b6e88431c17443eec/625aa/lerna-4.jpg\"\n        srcset=\"/static/0fd05fdb5e3aa37b6e88431c17443eec/c4d45/lerna-4.jpg 148w,\n/static/0fd05fdb5e3aa37b6e88431c17443eec/1f0d7/lerna-4.jpg 295w,\n/static/0fd05fdb5e3aa37b6e88431c17443eec/625aa/lerna-4.jpg 590w,\n/static/0fd05fdb5e3aa37b6e88431c17443eec/e52ee/lerna-4.jpg 726w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h3>使用lerna来管理项目依赖</h3>\n<p>引入<code>lerna</code>后，第一件事就是要处理安装依赖的问题，我们需要用<code>lerna add</code> 命令来代替我们习惯的<code>npm</code>或<code>yarn</code>，比如说给rntest项目安装<code>lodash</code>，就要执行下面的命令。</p>\n\n        <deckgo-highlight-code  >\n          <code slot=\"code\">lerna add lodash --scope=rntest</code>\n        </deckgo-highlight-code>\n      \n<p>不过，执行后你会发现其他项目中package-lock.json都发生了变化，让人非常困惑，这背后的原因是跟添加依赖后自动执行的安装命令<code>lerna bootstrap</code>有关。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/c63110d7e76ed344c29f3da1115fd19e/4be3c/lerna-5.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 43.24324324324324%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wgARCAAJABQDASIAAhEBAxEB/8QAGQAAAgMBAAAAAAAAAAAAAAAAAAQBAgMG/8QAFAEBAAAAAAAAAAAAAAAAAAAAAP/aAAwDAQACEAMQAAAB4ejihkQH/8QAGBAAAgMAAAAAAAAAAAAAAAAAEBEAAUH/2gAIAQEAAQUCcVDR/8QAFhEAAwAAAAAAAAAAAAAAAAAAARAR/9oACAEDAQE/AaF//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFhABAQEAAAAAAAAAAAAAAAAAEAFB/9oACAEBAAY/AtY//8QAGxABAQACAwEAAAAAAAAAAAAAAQARMUFxkfD/2gAIAQEAAT8hco8mfJAn47nbO7//2gAMAwEAAgADAAAAENfP/8QAFhEBAQEAAAAAAAAAAAAAAAAAARAx/9oACAEDAQE/EBDJ/8QAFxEAAwEAAAAAAAAAAAAAAAAAARARUf/aAAgBAgEBPxCHV//EAB4QAAICAQUBAAAAAAAAAAAAAAABESFBMWFxgaGx/9oACAEBAAE/EKsuUZeB67dkGkJvtQeZD7jU5P/Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"lerna 5\"\n        title=\"lerna 5\"\n        src=\"/static/c63110d7e76ed344c29f3da1115fd19e/625aa/lerna-5.jpg\"\n        srcset=\"/static/c63110d7e76ed344c29f3da1115fd19e/c4d45/lerna-5.jpg 148w,\n/static/c63110d7e76ed344c29f3da1115fd19e/1f0d7/lerna-5.jpg 295w,\n/static/c63110d7e76ed344c29f3da1115fd19e/625aa/lerna-5.jpg 590w,\n/static/c63110d7e76ed344c29f3da1115fd19e/f8367/lerna-5.jpg 885w,\n/static/c63110d7e76ed344c29f3da1115fd19e/fab84/lerna-5.jpg 1180w,\n/static/c63110d7e76ed344c29f3da1115fd19e/4be3c/lerna-5.jpg 1590w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h4>lerna的依赖提升</h4>\n<p><code>lerna</code>可以通过<code>lerna bootstrap</code>一行命令安装所有子项目的依赖包，而且在安装依赖时还有依赖提升功能，所谓“依赖提升”，就是把所有项目npm依赖文件都提升到根目录下，这样能避免相同依赖包在不同项目安装多次。比如多个项目都用了<code>redux</code>，通过依赖提升，多个项目一共只需要下载一次即可。不过，需要额外的参数<code>--hoist</code>让依赖提升生效。</p>\n\n        <deckgo-highlight-code  >\n          <code slot=\"code\">lerna bootstrap --hoist</code>\n        </deckgo-highlight-code>\n      \n<p>但是自动执行<code>lerna bootstrap</code>命令是不带依赖提升参数的，这就导致上面每个项目的lock文件都会被修改的原因。</p>\n<p>当然，要解决这个问题也容易，可以通过<code>lerna</code>的配置来避免npm对lock文件的修改即可，写法如下：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 574px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/cf95002c4ecaaca9b376b2ac4a6af039/74b23/lerna-6.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 106.08108108108108%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wgARCAAVABQDASIAAhEBAxEB/8QAGAABAAMBAAAAAAAAAAAAAAAAAAECAwb/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAf/aAAwDAQACEAMQAAAB5iLKzWUCQK//xAAZEAADAAMAAAAAAAAAAAAAAAAAAREQICH/2gAIAQEAAQUCRMJw5r//xAAWEQEBAQAAAAAAAAAAAAAAAAAAERD/2gAIAQMBAT8BRc//xAAWEQADAAAAAAAAAAAAAAAAAAAAEBH/2gAIAQIBAT8BK//EABUQAQEAAAAAAAAAAAAAAAAAACBB/9oACAEBAAY/AhD/AP/EAB0QAAIBBAMAAAAAAAAAAAAAAAABESExQVEQcYH/2gAIAQEAAT8hRO6fg8knHGkogbfMuiES4uV2V2f/2gAMAwEAAgADAAAAEDjA/P/EABgRAAMBAQAAAAAAAAAAAAAAAAABETFR/9oACAEDAQE/EGlNLK6Vn//EABcRAAMBAAAAAAAAAAAAAAAAAAABERD/2gAIAQIBAT8QrxERH//EAB8QAQACAQMFAAAAAAAAAAAAAAEAESEQMWFBUXHR8f/aAAgBAQABPxAq3dLhg8jTTYuAXGYVdHBeopSU8hUwAwDtL+BG28f/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"lerna 6\"\n        title=\"lerna 6\"\n        src=\"/static/cf95002c4ecaaca9b376b2ac4a6af039/74b23/lerna-6.jpg\"\n        srcset=\"/static/cf95002c4ecaaca9b376b2ac4a6af039/c4d45/lerna-6.jpg 148w,\n/static/cf95002c4ecaaca9b376b2ac4a6af039/1f0d7/lerna-6.jpg 295w,\n/static/cf95002c4ecaaca9b376b2ac4a6af039/74b23/lerna-6.jpg 574w\"\n        sizes=\"(max-width: 574px) 100vw, 574px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h4>yarn是lerna的最佳搭档</h4>\n<p><code>lerna</code>默认使用<code>npm</code>作为安装依赖包工具，但也可以选择其他工具。<code>yarn</code>在1.0版本之后提供了workspaces的功能，该功能从更底层的地方提供了依赖提升，做的事情跟<code>lerna</code>如出一辙。把它跟<code>lerna</code>放在一起看，简直就像是为<code>lerna</code>量身定做一样。因此，推荐在lerna中搭配yarn一起使用。</p>\n<p>把npm替换成yarn只需在lerna的配置文件添加两行代码即可，配置完以后立刻顺畅百倍。</p>\n<p><img src=\"./lerna-7.jpeg\"></p>\n<h3>高效的代码重用</h3>\n<p>在我参与的这个大前端项目里，多端之间代码重复的部分包含<code>redux</code>中的业务逻辑、http请求的处理、代码规范工具的检查、<code>git</code>钩子中的自定义脚本等等。在<code>lerna</code>架构下，前两者可直接抽取到一个独立的项目，然后被其他项目引用，比如在我的demo中，可以像其他依赖包一样直接引入<code>shared</code>项目, lerna会自动识别并把它导向内部项目。</p>\n\n        <deckgo-highlight-code language=\"javascript\" >\n          <code slot=\"code\">import shared from &#39;shared&#39;</code>\n        </deckgo-highlight-code>\n      \n<p>这跟直接封装成<code>npm</code>包的一大区别就是实时更新，修改立刻可见，就像在同一个项目一样，不影响开发和调试。</p>\n<h4>git钩子和自定义脚本的重用</h4>\n<p>我尝试把处理<code>git</code>钩子的工具<code>husky</code>安装到了根目录，触发的事件和自定义脚本能覆盖到每个项目，给这部分代码重用带来了极大便利。比如，不少项目会添加自定义脚本来约束<code>git commit</code>提交时的消息描述，在<code>lerna</code>架构下，只需写一次即可。</p>\n<h4>eslint的重用</h4>\n<p>那些常常需要在根目录添加配置文件的第三方依赖，比如<code>eslint</code>、<code>prettier</code>、<code>babel</code>等，在<code>lerna</code>中无法简单粗暴的提升合并到一处。因此，对于<code>eslint</code>这种前端开发已不可或缺的工具，可以尝试将所有配置项抽取到独立项目，然后安装第三方依赖的方式引入，类似<code>eslint-config-airbnb</code>，<code>eslint-config-prettier</code>，<code>eslint-config-google</code>这样。</p>\n<p>不得不说，即便不用<code>lerna</code>框架我们也可以这么做，只不过在<code>lerna</code>框架下修改立刻可见，方便了调试和开发。</p>\n<h3>lerna框架下的CI/CD</h3>\n<p>多项目的结构无疑给<code>CI/CD</code>带来挑战，好在主流的CI框架能完美解决这个问题。比如在gitlab上，<code>only/changes</code>参数完全满足了我们的需求，让我们可以为每一个子项目设置单独的pipeline，比如现在我们设置一个pipeline，只当rntest项目下的文件被修改时才会触发：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/e0646ac9b9bd05b8934c3287f9db05aa/1a8b3/lerna-8.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.94594594594595%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wgARCAAJABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAIBBv/EABYBAQEBAAAAAAAAAAAAAAAAAAEAAv/aAAwDAQACEAMQAAAB5mdNAc//xAAXEAADAQAAAAAAAAAAAAAAAAAAARAR/9oACAEBAAEFAkZEOf/EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQMBAT8BP//EABQRAQAAAAAAAAAAAAAAAAAAABD/2gAIAQIBAT8BP//EABQQAQAAAAAAAAAAAAAAAAAAACD/2gAIAQEABj8CX//EABwQAAEEAwEAAAAAAAAAAAAAAAEAECFBUWFxof/aAAgBAQABPyGQmdIhnxqq3G//2gAMAwEAAgADAAAAECg//8QAFREBAQAAAAAAAAAAAAAAAAAAEBH/2gAIAQMBAT8Qh//EABYRAAMAAAAAAAAAAAAAAAAAABARIf/aAAgBAgEBPxB0f//EAB4QAAIBAwUAAAAAAAAAAAAAAAERADFRgRAhQXGx/9oACAEBAAE/EBCnsYwJnYLNCBwXiVZyvo90/9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"lerna 8\"\n        title=\"lerna 8\"\n        src=\"/static/e0646ac9b9bd05b8934c3287f9db05aa/625aa/lerna-8.jpg\"\n        srcset=\"/static/e0646ac9b9bd05b8934c3287f9db05aa/c4d45/lerna-8.jpg 148w,\n/static/e0646ac9b9bd05b8934c3287f9db05aa/1f0d7/lerna-8.jpg 295w,\n/static/e0646ac9b9bd05b8934c3287f9db05aa/625aa/lerna-8.jpg 590w,\n/static/e0646ac9b9bd05b8934c3287f9db05aa/f8367/lerna-8.jpg 885w,\n/static/e0646ac9b9bd05b8934c3287f9db05aa/1a8b3/lerna-8.jpg 1022w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>在lerna框架下，所有项目都合在一个工程里，但<code>CI/CD</code>并不必这样。通过把脚本中的关键参数配置到<code>CI/CD</code>的项目内里，共用同一份<code>.gitlab-ci.yml</code>文件，从而能够实现每个子项目对应一个独立的<code>CI/CD</code>项目，最终<code>CI/CD</code>结构如下图：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/cee6feb33bff357788ebc3b536c730d1/5dd07/lerna-9.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 63.51351351351351%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wgARCAANABQDASIAAhEBAxEB/8QAGAAAAgMAAAAAAAAAAAAAAAAAAAIDBAb/xAAVAQEBAAAAAAAAAAAAAAAAAAACA//aAAwDAQACEAMQAAAB11hZ1JwDX//EAB0QAAEDBQEAAAAAAAAAAAAAAAECAxQAERITITH/2gAIAQEAAQUClJL3ih0R29uJvX//xAAXEQADAQAAAAAAAAAAAAAAAAACEBJC/9oACAEDAQE/AQvS/8QAFxEAAwEAAAAAAAAAAAAAAAAAAxASIf/aAAgBAgEBPwEk5K//xAAdEAABBAIDAAAAAAAAAAAAAAARAAIQEwExIjKB/9oACAEBAAY/Aqg7YK7Y9dFg5Ercf//EABwQAQACAwADAAAAAAAAAAAAAAEAESFBUTFxgf/aAAgBAQABPyHxuZlOZpIslnyB+yL3GwlTlECjLc//2gAMAwEAAgADAAAAELzP/8QAGBEAAwEBAAAAAAAAAAAAAAAAAREhEFH/2gAIAQMBAT8QEW4Ni5n/xAAYEQEAAwEAAAAAAAAAAAAAAAABEBFhcf/aAAgBAgEBPxBNpd7H/8QAHRABAQACAgMBAAAAAAAAAAAAAREAITFBUWFxgf/aAAgBAQABPxBrHVGBT3bNYoYaQJ3eTj5kynyul+5GXu2ZXLP3GIUAKpL24wlB3Jc//9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"lerna 9\"\n        title=\"lerna 9\"\n        src=\"/static/cee6feb33bff357788ebc3b536c730d1/625aa/lerna-9.jpg\"\n        srcset=\"/static/cee6feb33bff357788ebc3b536c730d1/c4d45/lerna-9.jpg 148w,\n/static/cee6feb33bff357788ebc3b536c730d1/1f0d7/lerna-9.jpg 295w,\n/static/cee6feb33bff357788ebc3b536c730d1/625aa/lerna-9.jpg 590w,\n/static/cee6feb33bff357788ebc3b536c730d1/f8367/lerna-9.jpg 885w,\n/static/cee6feb33bff357788ebc3b536c730d1/fab84/lerna-9.jpg 1180w,\n/static/cee6feb33bff357788ebc3b536c730d1/5dd07/lerna-9.jpg 1332w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h3>lerna框架下的子项目权限</h3>\n<p>由于所有的项目都归并到了一个<code>lerna</code>工程下，一旦有了访问权限意味着你可以修改所有子项目中的代码，在实际的开发工作中多多少少会带来一些麻烦。比如说，开发web和开发mobile平台的是两个不同的团队，假如我作为web组的一员，一不小心修改了或删除了mobile项目的文件该怎么办？假如不加入任何限制，这种事情迟早会发生，我想这可能是<code>lerna</code>框架与生俱来的的痛点。</p>\n<p>不幸的是，在<code>lerna</code>框架下，gitlab或github这类第三方代码托管平台，本身的权限管理功能无法解决这问题。但好在有其他工具的帮助可以缓解这种痛，我尝试用来约束开源贡献者提交PR规范的工具<code>dangerjs</code>来完成权限分隔，利用的信息就是当前gitlab账号的用户名，看起来效果还不错。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ce54120a40a9fa827663c495958e2268/1a428/lerna-10.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 85.8108108108108%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wgARCAARABQDASIAAhEBAxEB/8QAFwABAQEBAAAAAAAAAAAAAAAAAAIDBv/EABYBAQEBAAAAAAAAAAAAAAAAAAABAv/aAAwDAQACEAMQAAAB7LS7MW4zsmrFz//EABwQAAAGAwAAAAAAAAAAAAAAAAACAxARExQxQf/aAAgBAQABBQLGRmhIUJDssbbf/8QAFBEBAAAAAAAAAAAAAAAAAAAAIP/aAAgBAwEBPwEf/8QAFREBAQAAAAAAAAAAAAAAAAAAESD/2gAIAQIBAT8BY//EABkQAAIDAQAAAAAAAAAAAAAAAAIzACCSkf/aAAgBAQAGPwJQcigzFBm//8QAHRABAAEDBQAAAAAAAAAAAAAAAQAQETEhcYGx8f/aAAgBAQABPyEBdGA4PhPPTQbdLzdeDVMT/9oADAMBAAIAAwAAABBL6AH/xAAWEQEBAQAAAAAAAAAAAAAAAAAAARH/2gAIAQMBAT8QxiK//8QAFxEAAwEAAAAAAAAAAAAAAAAAAAEREP/aAAgBAgEBPxCisef/xAAeEAEAAQQCAwAAAAAAAAAAAAABABEhMUGB8GGxwf/aAAgBAQABPxBYGKqC56g1VnNn5Bc1OmpYSlW966gKYrviClxOJk4mpin/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"lerna 10\"\n        title=\"lerna 10\"\n        src=\"/static/ce54120a40a9fa827663c495958e2268/625aa/lerna-10.jpg\"\n        srcset=\"/static/ce54120a40a9fa827663c495958e2268/c4d45/lerna-10.jpg 148w,\n/static/ce54120a40a9fa827663c495958e2268/1f0d7/lerna-10.jpg 295w,\n/static/ce54120a40a9fa827663c495958e2268/625aa/lerna-10.jpg 590w,\n/static/ce54120a40a9fa827663c495958e2268/f8367/lerna-10.jpg 885w,\n/static/ce54120a40a9fa827663c495958e2268/fab84/lerna-10.jpg 1180w,\n/static/ce54120a40a9fa827663c495958e2268/1a428/lerna-10.jpg 2134w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>可以看到，此工具会在合并MR时，判断出我gitlab账号没有权限修改rntest子项目内的文件，从而禁止合并此MR，并将这些信息自动添加到MR的评论里。当然，脚本判断是自己写的仅用作演示，逻辑比较简陋，脚本代码如下：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/fdb43cba05b84a81cd4f10becf712e4e/133b2/lerna-11.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 35.13513513513513%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wgARCAAHABQDASIAAhEBAxEB/8QAFgABAQEAAAAAAAAAAAAAAAAAAAMG/8QAFQEBAQAAAAAAAAAAAAAAAAAAAQD/2gAMAwEAAhADEAAAAc0EmG//xAAXEAADAQAAAAAAAAAAAAAAAAABECEx/9oACAEBAAEFAhkX/8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAwEBPwE//8QAFBEBAAAAAAAAAAAAAAAAAAAAEP/aAAgBAgEBPwE//8QAFBABAAAAAAAAAAAAAAAAAAAAEP/aAAgBAQAGPwJ//8QAGBABAQEBAQAAAAAAAAAAAAAAAQAhUXH/2gAIAQEAAT8hQ6dk6n2//9oADAMBAAIAAwAAABD/AO//xAAVEQEBAAAAAAAAAAAAAAAAAAAQMf/aAAgBAwEBPxCn/8QAFREBAQAAAAAAAAAAAAAAAAAAARD/2gAIAQIBAT8QZ//EABsQAAICAwEAAAAAAAAAAAAAAAERACFRYZHR/9oACAEBAAE/EAC/ZwhlLw/ICNF2f//Z'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"lerna 11\"\n        title=\"lerna 11\"\n        src=\"/static/fdb43cba05b84a81cd4f10becf712e4e/625aa/lerna-11.jpg\"\n        srcset=\"/static/fdb43cba05b84a81cd4f10becf712e4e/c4d45/lerna-11.jpg 148w,\n/static/fdb43cba05b84a81cd4f10becf712e4e/1f0d7/lerna-11.jpg 295w,\n/static/fdb43cba05b84a81cd4f10becf712e4e/625aa/lerna-11.jpg 590w,\n/static/fdb43cba05b84a81cd4f10becf712e4e/f8367/lerna-11.jpg 885w,\n/static/fdb43cba05b84a81cd4f10becf712e4e/fab84/lerna-11.jpg 1180w,\n/static/fdb43cba05b84a81cd4f10becf712e4e/133b2/lerna-11.jpg 2838w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>关于<code>dangerjs</code>的部分我会另写一篇文章详细介绍。</p>\n<h3>结语</h3>\n<p>大前端项目将会是前端发展的趋势，如何更好的管理大前端项目是每一位前端开发躲不开的课题。<code>lerna</code>框架通过合而为一的理念提供了一种解决方案，通过扬长避短，我们可以发挥出<code>lerna</code>的最大效用。假如你还没有用过，也许，下一个项目就可以试试看。</p>\n<blockquote>\n<p><strong>相关资料</strong></p>\n</blockquote>\n<blockquote>\n<p><a href=\"https://classic.yarnpkg.com/en/docs/workspaces/\">yarn的workspaces</a></p>\n</blockquote>\n<blockquote>\n<p><a href=\"https://github.com/lerna/lerna\">lerna的github地址</a></p>\n</blockquote>\n<blockquote>\n<p><a href=\"https://gitlab.com/twomeetings/lerna-demo\">文章中的demo</a></p>\n</blockquote>","frontmatter":{"title":"大前端项目代码重用，也许lerna是最好的选择","date":"July 10, 2020","description":null,"cover":{"publicURL":"/static/cover-33876490d08b53714fcfd1a55aae07f8.jpeg"}}}},"pageContext":{"slug":"/2020-07-10-you-should-use-lerna-for-sharing-code/","previous":{"fields":{"slug":"/2020-07-01-how-to-write-hooks-like-component-in-redux/"},"frontmatter":{"title":"如何编写hooks风格的redux组件"}},"next":{"fields":{"slug":"/2020-07-14-the-addicting-ci-tool-dangerjs/"},"frontmatter":{"title":"试了就戒不掉的CI工具-dangerjs"}}}},"staticQueryHashes":["2841359383"]}