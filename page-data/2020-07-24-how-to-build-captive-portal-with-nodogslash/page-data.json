{"componentChunkName":"component---src-templates-blog-post-js","path":"/2020-07-24-how-to-build-captive-portal-with-nodogslash/","result":{"data":{"site":{"siteMetadata":{"title":"上线前夕"}},"markdownRemark":{"id":"3fbda457-d7ed-5cac-800b-1a7b1d239f16","excerpt":"日常生活中常能碰到一些商场或餐饮店提供一种需认证的wifi，这种wifi连接后不能立刻使用，往往还需要在一个页面上进一步认证操作才行，比如输入手机号填个验证码之类的。 作为一名前端开发，每当我去麦当劳店里吃饭，用手机连接wifi时，一直都很想搞清楚几个问题： 这种wifi…","html":"<p>日常生活中常能碰到一些商场或餐饮店提供一种需认证的wifi，这种wifi连接后不能立刻使用，往往还需要在一个页面上进一步认证操作才行，比如输入手机号填个验证码之类的。</p>\n<p>作为一名前端开发，每当我去麦当劳店里吃饭，用手机连接wifi时，一直都很想搞清楚几个问题：</p>\n<ul>\n<li>这种wifi认证页面是如何搭建的？</li>\n<li>它的认证机制是怎样的？</li>\n<li>它跟正常的网站会有哪些不一样？</li>\n</ul>\n<p>我工作地旁边的麦当劳wifi认证截图：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/196de2acca8af0eb2069f570ddb7a229/b2ead/captive-portal-%E9%BA%A6%E5%BD%93%E5%8A%B31.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 216.89189189189187%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wgARCAArABQDASIAAhEBAxEB/8QAGQABAAMBAQAAAAAAAAAAAAAAAAMEBQIG/8QAFwEBAQEBAAAAAAAAAAAAAAAAAAECA//aAAwDAQACEAMQAAAB9FFY7z0zWkS1xfVGlXBnk0GcP//EAB8QAAEEAgIDAAAAAAAAAAAAAAIAAQMEERQFEhMgIf/aAAgBAQABBQJ7OFt/S5SIHkrVHfxVeujVkRV4CLWrqMAjH2y6y67Ov//EAB0RAAECBwAAAAAAAAAAAAAAAAABAhAREhMiUWH/2gAIAQMBAT8Bp4Ylx+xVnH//xAAXEQADAQAAAAAAAAAAAAAAAAAAESEg/9oACAECAQE/AaUWP//EACIQAAEDAwMFAAAAAAAAAAAAAAEAAhEDITEgMmEzcXKRov/aAAgBAQAGPwLZc8q9M2UEFEOfB81Bq/andzMol1JpPZdFnpQxoaONeVlZX//EAB0QAQEBAQACAwEAAAAAAAAAAAERACExYRAgQXH/2gAIAQEAAT8hsI/AcZQyX9ZfZ/mHFTpzHVBECV7wGSTmTVK1Xy+M9RjYNDQ+vub3N7W//9oADAMBAAIAAwAAABBgw8Hf/wD/xAAaEQEAAwADAAAAAAAAAAAAAAABABEhQZGh/9oACAEDAQE/ENcvY0xGBFD7Yitdly5//8QAGhEAAgIDAAAAAAAAAAAAAAAAABEBEFFhcf/aAAgBAgEBPxCNjsTFIR//xAAfEAEAAgEEAwEAAAAAAAAAAAABABEhMUFRYSBx8YH/2gAIAQEAAT8Qy4sjUr0OvqLaXGwW9vyb1FQWPdxN8DmQbGrw98RwaQNR23mERYEbW155lbGzVXcXq2rrL+4sIW6sWbQudUANPD7s+5Cx5+Z//9k='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"captive portal    1\"\n        title=\"captive portal    1\"\n        src=\"/static/196de2acca8af0eb2069f570ddb7a229/625aa/captive-portal-%E9%BA%A6%E5%BD%93%E5%8A%B31.jpg\"\n        srcset=\"/static/196de2acca8af0eb2069f570ddb7a229/c4d45/captive-portal-%E9%BA%A6%E5%BD%93%E5%8A%B31.jpg 148w,\n/static/196de2acca8af0eb2069f570ddb7a229/1f0d7/captive-portal-%E9%BA%A6%E5%BD%93%E5%8A%B31.jpg 295w,\n/static/196de2acca8af0eb2069f570ddb7a229/625aa/captive-portal-%E9%BA%A6%E5%BD%93%E5%8A%B31.jpg 590w,\n/static/196de2acca8af0eb2069f570ddb7a229/f8367/captive-portal-%E9%BA%A6%E5%BD%93%E5%8A%B31.jpg 885w,\n/static/196de2acca8af0eb2069f570ddb7a229/b2ead/captive-portal-%E9%BA%A6%E5%BD%93%E5%8A%B31.jpg 1080w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/74709bc59e4f1d9e8a298d857c3843e7/b2ead/captive-portal-%E9%BA%A6%E5%BD%93%E5%8A%B32.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 216.89189189189187%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wgARCAArABQDASIAAhEBAxEB/8QAGwAAAgIDAQAAAAAAAAAAAAAAAAYCAwEEBwX/xAAVAQEBAAAAAAAAAAAAAAAAAAAAAf/aAAwDAQACEAMQAAABaY84pOpiKGpr4pPcIBfU9AqDWJ//xAAfEAABBAICAwAAAAAAAAAAAAADAAECBBEzBRQTFSP/2gAIAQEAAQUC7AGfsAUTCdF3KpqIL6uN8VIT8ZdyqaicXZefq7SrUbUIZWVl1//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8BX//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8BX//EACcQAAECAwcEAwAAAAAAAAAAAAEAAgMRchAhIjEyUYEEEjNCcZHR/9oACAEBAAY/AvPDB+Vf1ML7WGNDPKfUbDUnz7tRyl+rCDzJHD7bp9RsNScQ3NxWhEOhSv3Fua//xAAiEAABAwMEAwEAAAAAAAAAAAABABEhQVHwMWGBkRBxscH/2gAIAQEAAT8hJQEbEigcyeKBkhHouev4ytgprU7Eo3OzVwfqFfDgsEOdVMsrYLU+gSL+1EYQWZxJ7T5l8wTr1dOvV0BPJf/aAAwDAQACAAMAAAAQgA8MEP8A/8QAFxEAAwEAAAAAAAAAAAAAAAAAAAERIP/aAAgBAwEBPxDFRT//xAAXEQADAQAAAAAAAAAAAAAAAAAAAREg/9oACAECAQE/EMRkP//EACMQAQACAgIBAwUAAAAAAAAAAAEAESExUXFhQZGhEIHB0fD/2gAIAQEAAT8QYXii8PVy0UGsX33MHGFJp95lbn9v6fNSsIyLkp8wh0wGgRzVOB5G3qfNA0nT5ynB7Qmk2kV1AHIkL7QdcgAJg1w4zGsW2rsUej4Ycr8nPc/kb57iVAttp3P/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"captive portal    2\"\n        title=\"captive portal    2\"\n        src=\"/static/74709bc59e4f1d9e8a298d857c3843e7/625aa/captive-portal-%E9%BA%A6%E5%BD%93%E5%8A%B32.jpg\"\n        srcset=\"/static/74709bc59e4f1d9e8a298d857c3843e7/c4d45/captive-portal-%E9%BA%A6%E5%BD%93%E5%8A%B32.jpg 148w,\n/static/74709bc59e4f1d9e8a298d857c3843e7/1f0d7/captive-portal-%E9%BA%A6%E5%BD%93%E5%8A%B32.jpg 295w,\n/static/74709bc59e4f1d9e8a298d857c3843e7/625aa/captive-portal-%E9%BA%A6%E5%BD%93%E5%8A%B32.jpg 590w,\n/static/74709bc59e4f1d9e8a298d857c3843e7/f8367/captive-portal-%E9%BA%A6%E5%BD%93%E5%8A%B32.jpg 885w,\n/static/74709bc59e4f1d9e8a298d857c3843e7/b2ead/captive-portal-%E9%BA%A6%E5%BD%93%E5%8A%B32.jpg 1080w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>这种wifi的英文学名叫<strong>Captive Portal</strong>，在开源社区中早已存在一些组件可轻松搭建这种类型的wifi，比如wifiDog, CoovaChilli, nodogslash等。</p>\n<p>为了一探究竟，我用nodogslash在树莓派上搭建了一个带认证功能的wifi，并且使用React创建了自定义认证页面，尝试搞清楚整个认证流程背后的原理。</p>\n<p>最终认证页面效果如下，点击按钮即完成认证：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1adbbd735d5e26ef37da814bfd694e71/c87b7/captive-portal-%E8%87%AA%E5%AE%9A%E4%B9%89wifi%E5%85%A5%E5%8F%A3%E9%A1%B5.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 89.1891891891892%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAABYlAAAWJQFJUiTwAAACQklEQVQ4y42Ui46aQBSGff8n6SP0ETabbdKkNd5iVRRcUOSODAzz9z+zQMCu2Z7kOAMcv3OdmYFijPlSezvdNFzb7rmF1tS2HWxmTwEG/wDjJIGz28FzXTjHI3bcH5wTDtznefYBxBPpGENkIkVRILrdkN5C+J6HwPcRRxEul4v9NkR4o1HED/f7HY7jII5jqKpCEAeo63oCLbnsG4OSe0XVndOGpRiAWZYhSVOkXLfbLcIwRJIVcPwbaqWsYWuBBif+71vSYKEM1rVB2H6k0zu2wEbTj2ir0TAyQ29No5EW1eC5j8I6ZnplniPlvqJ9y6ZMgCJHpfG7bBBrg4RqMeziGCiAH29vWC2X2Gw2WK/XtjECHVJuO+DPSuN7prCvNbbUQrrLqMdAKfyRHT2fz1Z9NkV0ArSFLu9IowQqr1GmCmlcsSma8zUF5kxzPp9jtVrZ6GSVBooMKcuP5yZ4fT2xITG2f2IaR4wks7AxsCxLm6pEJ42TcUk4m2bcFAv0Cry8BATFWC4jLBYR3t9LGjXslcb4NPXNkVHrIZOmyE8U5YwoZNELpsARSnIaKAvrIxyfGnmvlJo4mwCDwGdtfjG6Bfb7Ha7Xqx1y8fwZcHqiDO0egPIgHRRVqrYHvo/kEfhMJidlPGcuD76MgYh+GBsZdkXntdVm0Irpq+5Ezfr8ReWlwGSV5/F82VrHCfa8XZyTxxvGxeHEW8c9Y3c4IuNIDcA+ElntxdAVXHScgdS0fy91Ftu+zsN9iP+Qr+o3tvsLA695FOBwnUcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"captive portal    wifi   \"\n        title=\"captive portal    wifi   \"\n        src=\"/static/1adbbd735d5e26ef37da814bfd694e71/102e5/captive-portal-%E8%87%AA%E5%AE%9A%E4%B9%89wifi%E5%85%A5%E5%8F%A3%E9%A1%B5.png\"\n        srcset=\"/static/1adbbd735d5e26ef37da814bfd694e71/83276/captive-portal-%E8%87%AA%E5%AE%9A%E4%B9%89wifi%E5%85%A5%E5%8F%A3%E9%A1%B5.png 148w,\n/static/1adbbd735d5e26ef37da814bfd694e71/ba02f/captive-portal-%E8%87%AA%E5%AE%9A%E4%B9%89wifi%E5%85%A5%E5%8F%A3%E9%A1%B5.png 295w,\n/static/1adbbd735d5e26ef37da814bfd694e71/102e5/captive-portal-%E8%87%AA%E5%AE%9A%E4%B9%89wifi%E5%85%A5%E5%8F%A3%E9%A1%B5.png 590w,\n/static/1adbbd735d5e26ef37da814bfd694e71/74549/captive-portal-%E8%87%AA%E5%AE%9A%E4%B9%89wifi%E5%85%A5%E5%8F%A3%E9%A1%B5.png 885w,\n/static/1adbbd735d5e26ef37da814bfd694e71/7213b/captive-portal-%E8%87%AA%E5%AE%9A%E4%B9%89wifi%E5%85%A5%E5%8F%A3%E9%A1%B5.png 1180w,\n/static/1adbbd735d5e26ef37da814bfd694e71/c87b7/captive-portal-%E8%87%AA%E5%AE%9A%E4%B9%89wifi%E5%85%A5%E5%8F%A3%E9%A1%B5.png 1240w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h3>wifi认证的机制和原理</h3>\n<p>每当设备连接wifi后，系统会自动做一个连通性校验，此校验的本质是发送一个HTTP请求。如果请求失败，则会触发相应机制要求用户输入登录凭证。如果请求成功，则表示网络已通，无任何回应，这个网络校验过程叫Captive Portal Detection (CPD)。</p>\n<p>不同的操作系统校验时的请求地址不一样，比如我用手边的android和iphone手机分别做了测试，他们对应校验地址如下：</p>\n<ul>\n<li><a href=\"http://connectivitycheck.smartisan.com/wifi.html\">http://connectivitycheck.smartisan.com/wifi.html</a> （坚果 pro3）</li>\n<li><a href=\"http://captive.apple.com/hotspot-detect.html\">http://captive.apple.com/hotspot-detect.html</a> （iphone 6）</li>\n</ul>\n<p>简单来说，wifi的认证过程通过一个HTTP GET请求即可完成。以我本文示例中使用的<code>nodogsplash</code>组件为例，其内部用C语言实现了一个服务器运行在2050端口。设备连上wifi时，wifi端会生成一个token，当设备被重定向到认证页面时，页面模板中包含此token，此时用户只需发送一个GET请求将此token传入到对应服务器的认证地址即可。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/827e187729b3e939b180723a0ef10e91/3933f/captive-portal-%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 36.486486486486484%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAABYlAAAWJQFJUiTwAAAA8klEQVQoz32RX0vDMBTF9/0/jPgke/JNHBsyxMH0wSrVdXFdgm1v2qRNckxjDZ37cyCEnFx+Obl3Ai/nHP6r98b27/l03ViTP6PfddtBqRbG2FjQqgJE1RHYWjfUuYPHIrDtDHJegmoF8U2wg1/wBEmSgDEGznkEv7ztsVxvj9JHoGw0tjsBWTfIvsSQwmLPXpGmaVhEBOM9YwxYXiAX1Xng+8cO19MZrm5muL17ROO/HhKKFJvNJ7Isg5QSRSlxv3jC/GGF+fLZB9AHvYzAPo2N/bGhR706TSEZeZjWOtyTbFBWtYcpjGcQgOemfMm/VPcDtVoiAGitl6cAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"captive portal     \"\n        title=\"captive portal     \"\n        src=\"/static/827e187729b3e939b180723a0ef10e91/102e5/captive-portal-%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86.png\"\n        srcset=\"/static/827e187729b3e939b180723a0ef10e91/83276/captive-portal-%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86.png 148w,\n/static/827e187729b3e939b180723a0ef10e91/ba02f/captive-portal-%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86.png 295w,\n/static/827e187729b3e939b180723a0ef10e91/102e5/captive-portal-%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86.png 590w,\n/static/827e187729b3e939b180723a0ef10e91/74549/captive-portal-%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86.png 885w,\n/static/827e187729b3e939b180723a0ef10e91/7213b/captive-portal-%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86.png 1180w,\n/static/827e187729b3e939b180723a0ef10e91/3933f/captive-portal-%E5%9F%BA%E6%9C%AC%E5%8E%9F%E7%90%86.png 1636w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>如果你配置了FAS，也就是说设置了自定义认证机制，比如说你想添加了一个手机验证环节，需要用户填入手机和验证码才能完成认证。那么<code>nodogsplash</code>在重定向登录页面的时候会把一些重要参数附带在请求地址的后面，让你的自定义入口页能获取到这些认证凭证，比如token之类的参数。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/471847de99f63a6683f91b6d1ebd031e/46db9/captive-portal-%E8%AE%A4%E8%AF%81%E9%A1%B5%E9%9D%A2-highlight.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 206.75675675675674%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAApCAYAAAA1bQl+AAAACXBIWXMAABYlAAAWJQFJUiTwAAAEEElEQVRIx+VWyY7rVBDNP7NnyxoJFmxYwg8ggcQTPLpf03mdefJsZ3ASp5PO6CTteDpUXScdx+mEBvUGcaWjuuO5VXVdVc45joMsRqMR+v0+KpUKms0mVFWFoiioVqsCw+FQ7Dns53G32xUyZ5omXoOu6yiVSqjVari/v0c+n38hNAzjZZ9lWdA0DcViCQadyc1mM1zCcrnEYrHAdDoV4DHj0t6npyfk8I4tCkPk4jhGGsARPI72iP8G3Hx/dyTkxnIaRHgizAgnt8fHCw7toMDhfOD7icmHiWkQ44e5j2+ePPxIkjc7foR5eE6+SylxQphMiBXkNz6+Gnv4wtnh64mH6jbA9zMf3009/LLy8bvr46eljz9IfnCDE80zhMmE5oVEtMOXIw/fkpaPpF3lORJEH9yE6GciLtJFzefwdQ1ZsziKhIY7koVNgI90sETaIvNIL4gTCKI4OvfhtfYaJS7MJSaPHYRqA4EhIzIVRJaGQEgV4WFuP2YEuoSQxmhrQM8E9Bbi2eT42QRSFfXffsXD7Q2aD3lMuh3IpQLarQakYgF6rYrG57zo26qC4s1HlD/dYN634bkr7OgSQc6EOyL0tRbqhQc0KQFoFKMKxaOkqLAHQ/SHDmwK+E7PhtFuw3kcY0BJQaa9fZq3aE+vWQf67RQhmcsatGQFdq+HRqMBk4hnHLsUxxzLi/kca9fFZr3GdrsVeCa422e4vQ5gW0fCkHzQIg0r9TparZZIU5xpOMtwZikWi7j7dIdCoSAu43G5XKF+HVVObZ//JA07R8LIkIRPynS4QaRMVGdy2twkAkZ1nxf5Il3XoMgy7a2hQbJdLiLupTQMlDp0Wlx7O6zILHezwWK1wpL6KzJxTaZxf7lyxTyvrzc0R/0VndkObcRd40jI7F75HjGZDlNOYMipvkSvSC9pKQl4zHtZ8rhBGo4GyXcoNKToqJbLuLu9hTMYQCLTDlCkFtqUlTVFhkFZuU5uUcnMjmXSYY8CORJRdvJh74hV1AvyHUv2VYUOsh/r5D/btkVt0YT/dPRozJIzdDrtvRAGQSBel1+QwYQyaSFJkpBMxn1e49rBki/jejOnz+mMMKS0zYu8kQlYcuHhqsZVjDVk2aNvlMF9roidTgds3RlhRD4YkO/G4zEmk4nAil7wn7RjCUjlQyY+gLXm23kDg/vpcRZnhEyQRdbhIjunLk3jhPCS+uwrDjOOHH4oluy7N5ucLYkbiggu4JwcDsV8TZFzrYxezNhpM9+ydpUwzpTH1zTJEl/14b9p/2PC4L9BGL/h3y9+4/9hELy3hpRb31dDNnngPKJPYDkY7WW2fw2j5HyP/iIGzgg51epC0kyoZgca9WXNgmK0RV81CdYV7M/w+WKN6na7i78AF2w/a3+HlhMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"captive portal      highlight\"\n        title=\"captive portal      highlight\"\n        src=\"/static/471847de99f63a6683f91b6d1ebd031e/102e5/captive-portal-%E8%AE%A4%E8%AF%81%E9%A1%B5%E9%9D%A2-highlight.png\"\n        srcset=\"/static/471847de99f63a6683f91b6d1ebd031e/83276/captive-portal-%E8%AE%A4%E8%AF%81%E9%A1%B5%E9%9D%A2-highlight.png 148w,\n/static/471847de99f63a6683f91b6d1ebd031e/ba02f/captive-portal-%E8%AE%A4%E8%AF%81%E9%A1%B5%E9%9D%A2-highlight.png 295w,\n/static/471847de99f63a6683f91b6d1ebd031e/102e5/captive-portal-%E8%AE%A4%E8%AF%81%E9%A1%B5%E9%9D%A2-highlight.png 590w,\n/static/471847de99f63a6683f91b6d1ebd031e/46db9/captive-portal-%E8%AE%A4%E8%AF%81%E9%A1%B5%E9%9D%A2-highlight.png 706w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>等你的自定义验证手机验证通过了，再选择将token以HTTP GET请求发送回原2050端口上的认证服务器，整个流程如下图所示：</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/47c0b74ae04b51fc378d6f4efb6ab746/1cf17/captive-portal-FAS%E5%90%8E%E7%9A%84%E5%8E%9F%E7%90%86.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 60.810810810810814%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAABYlAAAWJQFJUiTwAAABVElEQVQoz5VTa0/CMBTdPzcm/iAD6Hf9Aj6+KahBcENeyza20W7rY92xFJiDOQw3uWlz055zbs+thTOiKIpynzEGpYpa3Tp1cbMe5yZsZ4LrVgePT88H5xoBj1mroZRCt/eAi8srtNo3Ze0kYKlQCQjOwIWAlHJ3UaHff0O7c4sgCM4DzAVBHPrw/UCnD855o/J921bTm8GsGjRXOvMaWZYlSNaeIdsrPVD4F7MwreZ1MvMcUiczqoXgv4DVQxkTCGOKKE5KIBQ5cilqCpc+QRClp1tek0wbIDWrBEmyLQmZw7GHWK1CUEqxb2Qw8rDwyNaU6hxWFb5/TnHXfcF97xXThW9qabJGHIUacIUoijRpiuFogsHHGM7UrQ23VTXE9UJ8TVzY365ufcsuONWAG7AYTP+OjHGMnTnG9gyzZXBgaGlK0yiY0ZEpKIlBCDUG/PcJfgDkzamY8Qbt5AAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"captive portal FAS    \"\n        title=\"captive portal FAS    \"\n        src=\"/static/47c0b74ae04b51fc378d6f4efb6ab746/102e5/captive-portal-FAS%E5%90%8E%E7%9A%84%E5%8E%9F%E7%90%86.png\"\n        srcset=\"/static/47c0b74ae04b51fc378d6f4efb6ab746/83276/captive-portal-FAS%E5%90%8E%E7%9A%84%E5%8E%9F%E7%90%86.png 148w,\n/static/47c0b74ae04b51fc378d6f4efb6ab746/ba02f/captive-portal-FAS%E5%90%8E%E7%9A%84%E5%8E%9F%E7%90%86.png 295w,\n/static/47c0b74ae04b51fc378d6f4efb6ab746/102e5/captive-portal-FAS%E5%90%8E%E7%9A%84%E5%8E%9F%E7%90%86.png 590w,\n/static/47c0b74ae04b51fc378d6f4efb6ab746/74549/captive-portal-FAS%E5%90%8E%E7%9A%84%E5%8E%9F%E7%90%86.png 885w,\n/static/47c0b74ae04b51fc378d6f4efb6ab746/7213b/captive-portal-FAS%E5%90%8E%E7%9A%84%E5%8E%9F%E7%90%86.png 1180w,\n/static/47c0b74ae04b51fc378d6f4efb6ab746/1cf17/captive-portal-FAS%E5%90%8E%E7%9A%84%E5%8E%9F%E7%90%86.png 1762w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h4>认证站点的限制</h4>\n<p>需要注意的是，当用户设备连上wifi但还尚未通过验证时，网络访问是受限的，此时能访问的内容取决于防火墙的设置。比如我上面示例中，将站点配置在路由器上，网站端口是8080，依赖的后端服务器运行在端口8081上，此时必须在<code>nodogsplash</code>的防火墙规则中开放这两个端口，才能让未认证的用户设备访问的到。假如服务器配置在外网，就要将对应的域名或IP在防火墙中开放出来，具体配置方式参考<code>nodogsplash</code>关于<a href=\"https://nodogsplash.readthedocs.io/en/v4.5.1/fas.html\">FAS的文档</a>。</p>\n<p>另外，wifi认证页面的实现上要有一些额外的安全考量。比如在<code>nodogsplash</code>的官网文档中建议网站遵循一下安全准则：</p>\n<ol>\n<li>当认证成功后需立刻关闭浏览器</li>\n<li>禁止使用链接</li>\n<li>禁止文件下载功能</li>\n<li>禁止执行javascript</li>\n</ol>\n<p>关于第二条，可以使用表单提交的方式替换链接调整，而对于第四条，它的本意并不是禁止js功能，只是为了防止执行js语句引起的安全性问题。我在示例中搭建的网站使用了react框架，在android和ios上都能正常显示。</p>\n<p>因此，在功能实现上相比较通常的前端站点，自定义的wifi认证网站部分功能受限，但影响并不大，可以使用你自己擅长的前端框架来搭建。</p>\n<h3>创建需认证的wifi</h3>\n<blockquote>\n<p><strong>注意，如果你手边没有树莓派或Linux系统，或者对配置部分不感兴趣，直接跳过即可。</strong></p>\n</blockquote>\n<h4>准备工作</h4>\n<ul>\n<li>树莓派 4B</li>\n<li>hostapd和dnsmasq (用于创建wifi热点)</li>\n<li>nodogsplash (核心组件，管理wifi热点，提供认证功能)</li>\n</ul>\n<p>nodogsplash可以安装OpenWrt和Linux中，前者是开源的智能路由器操作系统，国内的一些路由器厂商通常是基于此系统定制的，后者就不必多介绍了，这次的示例就是安装在Linux系统上，为了方便安装调试，我直接使用一个树莓派4作为载体，用网线连通网络，用无线创建热点wifi。</p>\n<h4>创建wifi热点</h4>\n<p>在安装组件之前，首先将依赖包更新，然后安装<code>hostapd</code>和<code>dnsmasq</code>两个组件，前者用来创建wifi热点，后者用来处理DNS和DHCP等服务。</p>\n\n        <deckgo-highlight-code  >\n          <code slot=\"code\">sudo apt-get update\nsudo apt-get upgrade\n\nsudo apt-get install hostapd dnsmasq</code>\n        </deckgo-highlight-code>\n      \n<p>修改配置并指定一个wifi网段，配置文件在<code>/etc/dhcpcd.conf</code></p>\n\n        <deckgo-highlight-code  >\n          <code slot=\"code\">sudo vi /etc/dhcpcd.conf\n\n# ...\n\n# 文件内容如下：\ninterface wlan0\n    static ip_address=192.168.220.1/24\n    nohook wpa_supplicant</code>\n        </deckgo-highlight-code>\n      \n<p>其中wlan0是无线网卡的名称，可以通过<code>ifconfig</code>命令查询，IP地址可任意指定，只要不跟家中的wifi冲突即可，比如说此处设置的是192.168.220.*，而我家中的wifi网段是192.168.31.*。</p>\n<p>重启一下服务，让配置生效：</p>\n\n        <deckgo-highlight-code  >\n          <code slot=\"code\">sudo systemctl restart dhcpcd</code>\n        </deckgo-highlight-code>\n      \n<p>修改hostapd配置，用于设置wifi的名称和密码，其中ssid表示此wifi的名称，wpa_passphrase表示此wifi的密码。</p>\n\n        <deckgo-highlight-code  >\n          <code slot=\"code\">sudo vi /etc/hostapd/hostapd.conf\n\n# ...\n\n# 文件内容如下：\ninterface=wlan0\ndriver=nl80211\n\nhw_mode=g\nchannel=6\nieee80211n=1\nwmm_enabled=0\nmacaddr_acl=0\nignore_broadcast_ssid=0\n\nauth_algs=1\nwpa=2\nwpa_key_mgmt=WPA-PSK\nwpa_pairwise=TKIP\nrsn_pairwise=CCMP\n\n# wif的名称\nssid=Pi4-AP\n# wifi的秘密\nwpa_passphrase=pimylifeup</code>\n        </deckgo-highlight-code>\n      \n<h5>修改配置文件<code>/etc/default/hostapd</code></h5>\n<p>这时还需要再修改两个配置文件，一个是<code>hostapd</code>启动时的加载文件，需要将配置文件字段<code>DAEMON_CONF</code>指定为上面的文件地址，默认情况下该字段是被注释掉的。</p>\n\n        <deckgo-highlight-code  >\n          <code slot=\"code\">sudo nano /etc/default/hostapd\n\n# ...\n# 文件内容如下：\n# 将#DAEMON_CONF=&quot;&quot; 修改为下面这行\nDAEMON_CONF=&quot;/etc/hostapd/hostapd.conf&quot;</code>\n        </deckgo-highlight-code>\n      \n<h5>修改配置文件<code>/etc/init.d/hostapd</code></h5>\n<p>另一个配置文件是系统服务配置，同意将上文的配置文件地址赋值给<code>DAEMON_CONF</code>字段。</p>\n\n        <deckgo-highlight-code  >\n          <code slot=\"code\">sudo vi /etc/init.d/hostapd\n\n# ...\n\n# 文件内容如下：\n# 将DAEMON_CONF=修改为下面这行\nDAEMON_CONF=/etc/hostapd/hostapd.conf</code>\n        </deckgo-highlight-code>\n      \n<h5>修改配置文件<code>/etc/dnsmasq.conf</code></h5>\n<p>在此文件配置自定义wifi的网段、dns服务器等信息。</p>\n\n        <deckgo-highlight-code  >\n          <code slot=\"code\">sudo vi /etc/dnsmasq.conf\n\n# ...\n\n# 文件内容如下：\ninterface=wlan0       # 指定无线网卡名称 \nserver=114.114.114.114       # 使用dns服务器\ndhcp-range=192.168.220.50,192.168.220.150,12h  # 指定可用IP的网段范围和释放时间</code>\n        </deckgo-highlight-code>\n      \n<h5>无线网卡转发有线网卡</h5>\n<p>修改系统配置文件中的<code>net.ipv4.ip_forward</code>字段，激活转发功能，默认情况下，该字段是被注释掉的。</p>\n\n        <deckgo-highlight-code  >\n          <code slot=\"code\">sudo vi /etc/sysctl.conf\n\n# ...\n\n# 文件内容如下：\n# 将原#net.ipv4.ip_forward=1的注释符号去掉，修改为下面这行\nnet.ipv4.ip_forward=1</code>\n        </deckgo-highlight-code>\n      \n<p>重启系统，让此修改生效。</p>\n\n        <deckgo-highlight-code  >\n          <code slot=\"code\">sudo reboot</code>\n        </deckgo-highlight-code>\n      \n<p>然后，通过<code>iptables</code>命令实现网卡之间的信息转发，其中<code>eth0</code>是有线网卡的名称，可通过<code>ifconfig</code>命令查询。</p>\n\n        <deckgo-highlight-code  >\n          <code slot=\"code\">sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE</code>\n        </deckgo-highlight-code>\n      \n<p>最后，需要将当前<code>iptables</code>的配置保存下来，保证每次机器重启时该配置都能生效，先将配置保存到文件中<code>/etc/iptables.ipv4.nat</code>。</p>\n\n        <deckgo-highlight-code  >\n          <code slot=\"code\"># 将配置写入/etc/iptables.ipv4.nat文件\nsudo sh -c &quot;iptables-save &gt; /etc/iptables.ipv4.nat&quot;</code>\n        </deckgo-highlight-code>\n      \n<p>修改<code>rc.local</code>，保证每次启动时都会读取<code>iptables</code>配置。</p>\n\n        <deckgo-highlight-code  >\n          <code slot=\"code\">sudo vi /etc/rc.local\n\n# ...\n# 文件内容如下：\n\n# ...\n# 在“exit 0”这一行之前添加下面命令读取iptables的配置\niptables-restore &lt; /etc/iptables.ipv4.nat\n\nexit 0</code>\n        </deckgo-highlight-code>\n      \n<h5>启动wifi热点</h5>\n<p>最后，关于热点的配置终于配置完毕，运行一下命令启动服务：</p>\n\n        <deckgo-highlight-code  >\n          <code slot=\"code\">sudo systemctl unmask hostapd\nsudo systemctl enable hostapd\nsudo systemctl start hostapd\nsudo service dnsmasq start</code>\n        </deckgo-highlight-code>\n      \n<p>这时，应该可以用手机检测到配置的wifi出现了<code>Pi4-AP</code>，该名称即上面配置的wifi名称，输入对应密码即可连上网络。此时可重启一下再连，确保重启后配置依然生效。</p>\n\n        <deckgo-highlight-code  >\n          <code slot=\"code\">sudo reboot</code>\n        </deckgo-highlight-code>\n      \n<h4>安装nodogsplash</h4>\n<p>首先安装对应依赖<code>git</code>和<code>libmicrohttpd-dev</code>。</p>\n\n        <deckgo-highlight-code  >\n          <code slot=\"code\">sudo apt install git libmicrohttpd-dev</code>\n        </deckgo-highlight-code>\n      \n<p>然后使用git直接将nodogsplash源码拿下来，直接安装。</p>\n\n        <deckgo-highlight-code  >\n          <code slot=\"code\">git clone https://github.com/nodogsplash/nodogsplash.git\ncd ./nodogsplash\nmake\nsudo make install</code>\n        </deckgo-highlight-code>\n      \n<h4>添加nodogsplash配置</h4>\n<p>添加配置到文件<code>/etc/nodogsplash/nodogsplash.conf</code>中，指定对应网卡、网关、最大连接用户数和认证过期时间。其中，<code>wlan0</code>是上面配置的无线网卡名，IP地址是上面配置的wifi热点的网关。</p>\n\n        <deckgo-highlight-code  >\n          <code slot=\"code\">sudo vi /etc/nodogsplash/nodogsplash.conf\n\n# ...\n\n# 文件内容如下：\nGatewayInterface wlan0\nGatewayAddress 192.168.220.1\nMaxClients 250\nAuthIdleTimeout 480</code>\n        </deckgo-highlight-code>\n      \n<p>配置完成后，启动nodogsplash。</p>\n\n        <deckgo-highlight-code  >\n          <code slot=\"code\">sudo nodogsplash</code>\n        </deckgo-highlight-code>\n      \n<p>此时，用手机连接创建的wifi并输入密码以后，即可看到以下弹窗，要求登录认证。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1762d04da53b6e8797de2aeb27e49c72/b2ead/captive-portal-wifi-popup.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 216.89189189189187%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wgARCAArABQDASIAAhEBAxEB/8QAGgABAAIDAQAAAAAAAAAAAAAAAAECAwQGBf/EABQBAQAAAAAAAAAAAAAAAAAAAAD/2gAMAwEAAhADEAAAAdAsQDtNrkMpZ54wWrYgH//EABsQAAMAAgMAAAAAAAAAAAAAAAIDBAAgBRQV/9oACAEBAAEFAtp0rKXrKzkhEKRueAehTjWm89v/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/AV//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AV//xAAiEAABAwMDBQAAAAAAAAAAAAABAAIRAxIgISIxMjNBkZL/2gAIAQEABj8CypTSE28wu2PQQDWhu3wmta4QONF1j5V1Qyc//8QAHhAAAwACAQUAAAAAAAAAAAAAAAERECExUYGRsfH/2gAIAQEAAT8hp3KauXwwyNx2KnuBJIlxJ1FZa5SlefCJiRmlCz7hi5wz/9oADAMBAAIAAwAAABDjCgyAD//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQMBAT8QX//EABQRAQAAAAAAAAAAAAAAAAAAACD/2gAIAQIBAT8QX//EACEQAQACAQQBBQAAAAAAAAAAAAEAESExQVFxEGGBkaHR/9oACAEBAAE/EDJxXrC7tDxtUbuYYclyzk+Y6wKuZVSbqZlc3A6ZX1HwlRBd8IGUQIQNM1mVO1AoEEoii9judHvTxqiWu1fnjVP/2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"captive portal wifi popup\"\n        title=\"captive portal wifi popup\"\n        src=\"/static/1762d04da53b6e8797de2aeb27e49c72/625aa/captive-portal-wifi-popup.jpg\"\n        srcset=\"/static/1762d04da53b6e8797de2aeb27e49c72/c4d45/captive-portal-wifi-popup.jpg 148w,\n/static/1762d04da53b6e8797de2aeb27e49c72/1f0d7/captive-portal-wifi-popup.jpg 295w,\n/static/1762d04da53b6e8797de2aeb27e49c72/625aa/captive-portal-wifi-popup.jpg 590w,\n/static/1762d04da53b6e8797de2aeb27e49c72/f8367/captive-portal-wifi-popup.jpg 885w,\n/static/1762d04da53b6e8797de2aeb27e49c72/b2ead/captive-portal-wifi-popup.jpg 1080w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>点击登录后进入认证页面。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/aa330c0c7a21d2ceb6c45007149a43a8/b2ead/captive-portal-splash-page.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 216.89189189189187%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDAAgGBgcGBQgHBwcJCQgKDBQNDAsLDBkSEw8UHRofHh0aHBwgJC4nICIsIxwcKDcpLDAxNDQ0Hyc5PTgyPC4zNDL/2wBDAQkJCQwLDBgNDRgyIRwhMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjIyMjL/wgARCAArABQDASIAAhEBAxEB/8QAGgAAAgMBAQAAAAAAAAAAAAAAAAMBAgQGBf/EABUBAQEAAAAAAAAAAAAAAAAAAAEA/9oADAMBAAIQAxAAAAHp9Hi9EyCAk7soElBajJhQwr//xAAdEAACAgIDAQAAAAAAAAAAAAABAgADERIEIDIi/9oACAEBAAEFAjegYbGElZZxCxX5Wz0lubcR/W5m5hOe/wD/xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAEDAQE/AV//xAAUEQEAAAAAAAAAAAAAAAAAAAAg/9oACAECAQE/AV//xAAjEAABAgMJAQAAAAAAAAAAAAABAAIDEBMSIzAxMkFRcqLB/9oACAEBAAY/AiC5oPYLSZRbNIGJuWoDgSp3nxZ+sP8A/8QAIBABAAICAQQDAAAAAAAAAAAAAQARITFBIFFxgZGh0f/aAAgBAQABPyEcN3eL7mE2HGv2I0hEYpZctVHp8Bsjv1g4dg24+c8kY+ne4AVxPBHdvX//2gAMAwEAAgADAAAAELMJ/O8//8QAGBEBAAMBAAAAAAAAAAAAAAAAAQAQETH/2gAIAQMBAT8QRO0CdrZs/8QAGREAAgMBAAAAAAAAAAAAAAAAABEBEEFR/9oACAECAQE/EHHKh7SEf//EACMQAAICAQQABwAAAAAAAAAAAAERACExQVFhkSBxgbHB0eH/2gAIAQEAAT8QrwIAp8wLj1EaMayAS9ahZgm4nlJ0QBEpabqAtViNIAbxERs1ftDdAijAAayi/s+oKA3u+SAokIFicfWUfaVBeB8DqPgdQGzjO0//2Q=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"captive portal splash page\"\n        title=\"captive portal splash page\"\n        src=\"/static/aa330c0c7a21d2ceb6c45007149a43a8/625aa/captive-portal-splash-page.jpg\"\n        srcset=\"/static/aa330c0c7a21d2ceb6c45007149a43a8/c4d45/captive-portal-splash-page.jpg 148w,\n/static/aa330c0c7a21d2ceb6c45007149a43a8/1f0d7/captive-portal-splash-page.jpg 295w,\n/static/aa330c0c7a21d2ceb6c45007149a43a8/625aa/captive-portal-splash-page.jpg 590w,\n/static/aa330c0c7a21d2ceb6c45007149a43a8/f8367/captive-portal-splash-page.jpg 885w,\n/static/aa330c0c7a21d2ceb6c45007149a43a8/b2ead/captive-portal-splash-page.jpg 1080w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h3><a href=\"#section-2\">配置自定义wifi认证页面</a></h3>\n<p><code>nodogsplash</code>本身提供了自定义验证机制 - <a href=\"https://nodogsplash.readthedocs.io/en/v4.5.1/fas.html\">Forwarding Authentication Service (FAS)</a>，它可以指定自定义的认证页面和认证方式，通过简单配置对应服务器的IP和端口即可。</p>\n<p>比如，我在同一台机器上开启一个react站点，端口为8080，若想把此站点设置为认证入口页，只需在配置文件中添加下面四行代码即可，其中<code>fas_secure_enabled</code>有<a href=\"https://nodogsplash.readthedocs.io/en/v4.5.1/fas.html#example-fas-query-strings\">从0到3的多个等级值</a>，从低到高会让安全性和复杂性递增，此处选了最简单等级用于做演示。</p>\n\n        <deckgo-highlight-code  >\n          <code slot=\"code\">sudo vi /etc/nodogsplash/nodogsplash.conf\n\n# ...\n\n# 要添加的内容如下\nfasport 8080\nfasremoteip 192.168.220.1\nfaspath /\nfas_secure_enabled 0</code>\n        </deckgo-highlight-code>\n      \n<p>最后，呈现的样子如下，点击按钮即完成认证，顺利联网。</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto;  max-width: 590px;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/1adbbd735d5e26ef37da814bfd694e71/c87b7/captive-portal-%E8%87%AA%E5%AE%9A%E4%B9%89wifi%E5%85%A5%E5%8F%A3%E9%A1%B5.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 89.1891891891892%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAASCAYAAABb0P4QAAAACXBIWXMAABYlAAAWJQFJUiTwAAACQklEQVQ4y42Ui46aQBSGff8n6SP0ETabbdKkNd5iVRRcUOSODAzz9z+zQMCu2Z7kOAMcv3OdmYFijPlSezvdNFzb7rmF1tS2HWxmTwEG/wDjJIGz28FzXTjHI3bcH5wTDtznefYBxBPpGENkIkVRILrdkN5C+J6HwPcRRxEul4v9NkR4o1HED/f7HY7jII5jqKpCEAeo63oCLbnsG4OSe0XVndOGpRiAWZYhSVOkXLfbLcIwRJIVcPwbaqWsYWuBBif+71vSYKEM1rVB2H6k0zu2wEbTj2ir0TAyQ29No5EW1eC5j8I6ZnplniPlvqJ9y6ZMgCJHpfG7bBBrg4RqMeziGCiAH29vWC2X2Gw2WK/XtjECHVJuO+DPSuN7prCvNbbUQrrLqMdAKfyRHT2fz1Z9NkV0ArSFLu9IowQqr1GmCmlcsSma8zUF5kxzPp9jtVrZ6GSVBooMKcuP5yZ4fT2xITG2f2IaR4wks7AxsCxLm6pEJ42TcUk4m2bcFAv0Cry8BATFWC4jLBYR3t9LGjXslcb4NPXNkVHrIZOmyE8U5YwoZNELpsARSnIaKAvrIxyfGnmvlJo4mwCDwGdtfjG6Bfb7Ha7Xqx1y8fwZcHqiDO0egPIgHRRVqrYHvo/kEfhMJidlPGcuD76MgYh+GBsZdkXntdVm0Irpq+5Ezfr8ReWlwGSV5/F82VrHCfa8XZyTxxvGxeHEW8c9Y3c4IuNIDcA+ElntxdAVXHScgdS0fy91Ftu+zsN9iP+Qr+o3tvsLA695FOBwnUcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"captive portal    wifi   \"\n        title=\"captive portal    wifi   \"\n        src=\"/static/1adbbd735d5e26ef37da814bfd694e71/102e5/captive-portal-%E8%87%AA%E5%AE%9A%E4%B9%89wifi%E5%85%A5%E5%8F%A3%E9%A1%B5.png\"\n        srcset=\"/static/1adbbd735d5e26ef37da814bfd694e71/83276/captive-portal-%E8%87%AA%E5%AE%9A%E4%B9%89wifi%E5%85%A5%E5%8F%A3%E9%A1%B5.png 148w,\n/static/1adbbd735d5e26ef37da814bfd694e71/ba02f/captive-portal-%E8%87%AA%E5%AE%9A%E4%B9%89wifi%E5%85%A5%E5%8F%A3%E9%A1%B5.png 295w,\n/static/1adbbd735d5e26ef37da814bfd694e71/102e5/captive-portal-%E8%87%AA%E5%AE%9A%E4%B9%89wifi%E5%85%A5%E5%8F%A3%E9%A1%B5.png 590w,\n/static/1adbbd735d5e26ef37da814bfd694e71/74549/captive-portal-%E8%87%AA%E5%AE%9A%E4%B9%89wifi%E5%85%A5%E5%8F%A3%E9%A1%B5.png 885w,\n/static/1adbbd735d5e26ef37da814bfd694e71/7213b/captive-portal-%E8%87%AA%E5%AE%9A%E4%B9%89wifi%E5%85%A5%E5%8F%A3%E9%A1%B5.png 1180w,\n/static/1adbbd735d5e26ef37da814bfd694e71/c87b7/captive-portal-%E8%87%AA%E5%AE%9A%E4%B9%89wifi%E5%85%A5%E5%8F%A3%E9%A1%B5.png 1240w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<h4>备注：关于nodogsplash的版本</h4>\n<blockquote>\n<p>nodogsplash源码中的master分支指向的3.3.5版本，而此时最新版是5.0.0（笔者写此文章时间2020.7），越新的版本其文档越完善，但要注意的是4.5.1版本是一个分水岭，因为从4.5.1之后该项目的自定义登录授权功能被剥离到一个独立项目<a href=\"https://github.com/openNDS/openNDS\">openNDS</a>。</p>\n</blockquote>\n<blockquote>\n<p>假如切换到v4.5.1版后碰到<code>libmicrohttpd</code>报<a href=\"https://raspberrypi.stackexchange.com/questions/108803/issue-with-nodogsplash-saying-it-needed-updateed-libmicrohttpd-dev-but-i-seems\">组件过时异常</a>，可在配置文件中添加字段<code>se_outdated_mhd 1</code>避开此异常。</p>\n</blockquote>\n<h3>结语</h3>\n<p>带认证的wifi在商业活动中越来越常见，开源社区中，<code>nodogsplash</code>是其中一种实现方式，在少量限制的情况下，提供了足够的灵活性让你用熟悉的方式像搭建其他网站一样搭建wifi认证页面。最终，把你的前端能力延伸到路由器上。</p>\n<h4>参考文献</h4>\n<blockquote>\n<p><a href=\"https://github.com/nodogsplash/nodogsplash\">nodogsplash的github地址</a></p>\n</blockquote>\n<blockquote>\n<p><a href=\"https://nodogsplashdocs.readthedocs.io/en/stable/\">nodogsplash的官方文档</a></p>\n</blockquote>\n<blockquote>\n<p><a href=\"https://blogs.arubanetworks.com/industries/rfc-7710-captive-portal-identification-using-dhcp-or-router-advertisements-ras/\">captive-portal和rfc-7710文献关联</a></p>\n</blockquote>\n<blockquote>\n<p><a href=\"https://wiki.mozilla.org/QA/Captive_Portals\">Captive-Portal的wiki</a></p>\n</blockquote>\n<blockquote>\n<p><a href=\"https://pimylifeup.com/raspberry-pi-wireless-access-point/\">树莓派搭建wifi热点</a></p>\n</blockquote>\n<blockquote>\n<p><a href=\"https://pimylifeup.com/raspberry-pi-captive-portal/\">树莓派搭建captive-portal</a></p>\n</blockquote>","frontmatter":{"title":"如何搭建类似麦当劳店中需登录认证的wifi","date":"July 24, 2020","description":null,"cover":{"publicURL":"/static/cover-d4e2b13401c6c5856cd04ee80787b974.png"}}}},"pageContext":{"slug":"/2020-07-24-how-to-build-captive-portal-with-nodogslash/","previous":{"fields":{"slug":"/2020-07-14-the-addicting-ci-tool-dangerjs/"},"frontmatter":{"title":"试了就戒不掉的CI工具-dangerjs"}},"next":{"fields":{"slug":"/2020-07-29-the-diff-between-promise-all-and-promise-allsettled/"},"frontmatter":{"title":"Promise.all和Promise.allSettled的区别"}}}},"staticQueryHashes":["2841359383"]}